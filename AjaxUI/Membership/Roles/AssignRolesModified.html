<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        div {
            margin-bottom: 10px;
        }

        label {
            display: inline-block;
            width: 100px;
        }

        input,
        select,
        button {
            padding: 5px;
            margin-left: 10px;
        }

        #lobs div,
        #roles div,
        #user div {
            align-items: left;
            display: inline-block;
            margin-right: 10px;
        }

        #dataDisplay div {
            margin-right: 5px;
        }

        .radio {
            margin-right: 5px;
        }
    </style>
    <title>Users information According to LOB And their Roles</title>
</head>

<body>

    <div id="lobs"></div>
    <br />
    <br />
    <div id="roles">
        <p>Role According To Selected LOB</p>
    </div>
    <br />
    <br />

    <div>
        <select id="user"></select>
    </div>
    <br />
    <br />
    <div id="dataDisplay"></div>

    <script>
        $(document).ready(function () {
            var selectedLob, selectedRole;

            function fetchData(url, callback, errorMsg) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    contentType: 'application/json',
                    success: callback,
                    error: function (xhr) {
                        console.error(xhr.responseText);
                        alert(errorMsg);
                    }
                });
            }

            function createRadioButtons(container, items, name, callback) {
                container.empty();
                items.forEach(function (item) {
                    var radiobutton = $('<input>').attr({
                        type: 'radio',
                        value: item,
                        name: name
                    });
                    var label = $('<label>').text(item).prepend(radiobutton);
                    container.append($('<div>').addClass('radio').append(radiobutton).append(label));
                });
                $(`input[name="${name}"]`).change(callback);
            }

            function fetchRoles() {
                fetchData(
                    `http://localhost:5000/api/roles/lobs`,
                    function (data) {
                        console.log("LOB: ", data);
                        createRadioButtons($('#lobs'), data, 'lob', function () {
                            selectedLob = $("input[name='lob']:checked").val();
                            console.log("Selected LOB: " + selectedLob);
                            fetchRolesByLob(selectedLob);
                        });
                    },
                    "An error occurred while fetching the LOBs. Please try again."
                );
            }

            function fetchRolesByLob(lob) {
                if (lob) {
                    fetchData(
                        `http://localhost:5000/api/roles/lob/${lob}`,
                        function (data) {
                            if (data.length > 0) {
                                createRadioButtons($('#roles'), data.map(role => role.name), 'roleName', function () {
                                    selectedRole = $("input[name='roleName']:checked").val();
                                    console.log("Selected role: " + selectedRole);
                                    fetchUsersByRoleAndLob(selectedRole, selectedLob);
                                });
                            } else {
                                alert("No Roles Found.");
                            }
                        },
                        "Error fetching roles."
                    );
                } else {
                    alert("Please select a LOB.");
                }
            }

            function fetchUsersByRoleAndLob(role, lob) {
                if (role && lob) {
                    fetchData(
                        `http://localhost:5000/api/roles/getuserbyroles/rolename/${role}/lob/${lob}`,
                        function (data) {
                            console.log("Users: ", data);
                            $('#user').empty();
                            data.forEach(function (user) {
                                $('#user').append($('<option>').attr('value', user.id).text(user.firstName));
                            });
                            $('#user').change(function () {
                                var userId = $(this).val();
                                displayUserDetails(data, userId);
                            });
                        },
                        "An error occurred while fetching the users. Please try again."
                    );
                } else {
                    alert("Please select a role.");
                }
            }

            function displayUserDetails(users, userId) {
                var user = users.find(user => user.id == userId);
                if (user) {
                    $('#dataDisplay').html(`
                        <div>
                            <p>Id: ${user.id}</p>
                            <p>First Name: ${user.firstName}</p>
                            <p>Last Name: ${user.lastName}</p>
                            <p>Gender: ${user.gender}</p>
                            <p>Contact Number: ${user.contactNumber}</p>
                            <p>Email: ${user.email}</p>
                            <p>Birth Date: ${user.birthDate}</p>
                            <p>Aadhar Id: ${user.aadharId}</p>
                        </div>
                    `);
                }
            }

            fetchRoles();
        });
    </script>
</body>

</html>
